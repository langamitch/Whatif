rules_version = '2';

// The service cloud.firestore block scopes the rules to your Firestore database.
service cloud.firestore {
  match /databases/{database}/documents {

    // Target the 'posts' collection specifically.
    match /posts/{postId} {

      // --- READ RULE ---
      // Anyone can read the list of posts or individual posts.
      // This allows your public suggestion board to be visible to all visitors.
      allow read: if true;

      // --- CREATE RULE ---
      // A user can create a new post only if the following conditions are met.
      // This protects your database from spam and malformed data.
      allow create: if isRequestingUserDataValid();

      // --- UPDATE & DELETE RULES ---
      // Nobody is allowed to update or delete a post once it has been created.
      allow update, delete: if false;
    }

    // --- Helper Function ---
    // This function validates the data being submitted for a new post.
    function isRequestingUserDataValid() {
      // The `request.resource.data` variable refers to the document that is about to be written.
      let data = request.resource.data;

      // Check that all required fields are present and have the correct data type.
      return data.name is string && data.name.size() > 0 &&
             data.suggestion is string && data.suggestion.size() > 0 &&
             data.socialLink is string && data.socialLink.matches('^https?://.*') &&
             // Ensure the timestamp is being set by the server, not the client.
             data.timestamp == request.time;
    }
  }
}
